<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>롤링페이퍼</title>
  <style>
    :root{
      --bg:#ffffff; --text:#111827; --muted:#6b7280;
      --card:#ffffff; --border:#e5e7eb; --soft:#f8fafc;
      --accent:#2563eb; --accent-2:#10b981;
      --danger:#ef4444; --warning:#f59e0b; --ok:#16a34a;
      --shadow:0 8px 20px rgba(0,0,0,.06); --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      /* 파스텔 보케 느낌 배경 */
      background:
        radial-gradient(1200px 900px at -10% -10%, #e0f2ff 0%, transparent 60%),
        radial-gradient(900px 700px at 110% -10%, #fef3c7 0%, transparent 55%),
        radial-gradient(900px 700px at 50% 120%, #dcfce7 0%, transparent 55%),
        linear-gradient(#ffffff,#ffffff);
      background-attachment: fixed;
      overflow-x:hidden;
    }
    /* 살짝 움직이는 배경 조명 */
    @keyframes floatGlow {
      0% { filter:saturate(110%) brightness(102%); }
      50%{ filter:saturate(120%) brightness(105%); }
      100%{ filter:saturate(110%) brightness(102%); }
    }
    body::after{
      content:""; position:fixed; inset:-10% -10% -10% -10%; z-index:-1; pointer-events:none;
      background:
        radial-gradient(40vw 30vw at 20% 20%, rgba(99,102,241,.10), transparent 60%),
        radial-gradient(45vw 35vw at 80% 15%, rgba(16,185,129,.10), transparent 60%),
        radial-gradient(60vw 45vw at 50% 85%, rgba(250,204,21,.10), transparent 60%);
      animation: floatGlow 10s ease-in-out infinite;
    }

    a{color:var(--accent); text-decoration:none}
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px;}
    .logo{display:flex; gap:10px; align-items:center}
    .logo i{width:36px; height:36px; background:linear-gradient(135deg,#60a5fa,#34d399); border-radius:10px; box-shadow:var(--shadow)}
    .tag{padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px; background:var(--soft)}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);}
    .section{padding:16px}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 16px; border-bottom:1px solid var(--border); background:var(--soft); border-top-left-radius:var(--radius); border-top-right-radius:var(--radius)}
    .content{padding:16px}
    .h{font-size:20px; font-weight:800}
    .sub{font-size:13px; color:var(--muted)}
    .grid{display:grid; gap:14px; grid-template-columns: repeat( auto-fill, minmax(230px, 1fr) );}
    .person{padding:16px; display:flex; flex-direction:column; gap:10px; position:relative}
    .counts{display:flex; gap:10px; color:var(--muted); font-size:12px}
    .counts span{padding:4px 8px; border-radius:999px; background:var(--soft); border:1px solid var(--border)}
    .pill{position:absolute; right:10px; top:10px; font-size:11px; color:#0b7; padding:4px 8px; border-radius:999px; background:#ecfeff; border:1px solid #99f}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .hidden{display:none !important}
    .row{display:flex; gap:10px; align-items:center}
    input[type=text], textarea{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid var(--border); background:#fff; color:var(--text); outline:none; transition:.15s;
    }
    input[type=text]:focus, textarea:focus{border-color:#93c5fd; box-shadow:0 0 0 4px #dbeafe}
    textarea{min-height:140px; resize:vertical; line-height:1.5}
    button{
      border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:700;
      background:var(--accent); color:white; box-shadow:var(--shadow); transition:.12s;
    }
    button.outline{background:#fff; border:1px solid var(--border); color:var(--text)}
    button.ghost{background:transparent; color:var(--muted); box-shadow:none}
    button.danger{background:var(--danger)} button.ok{background:var(--accent-2); color:#064e3b}
    button:disabled{opacity:.5; cursor:not-allowed}
    .note{padding:10px 12px; background:var(--soft); border:1px solid var(--border); border-radius:12px; color:#374151}
    .toast{
      position: fixed; left:50%; bottom: 22px; transform: translateX(-50%) translateY(20px);
      transition:.25s; opacity:0; background:#111827; color:white; border:1px solid rgba(255,255,255,.08);
      padding:10px 14px; border-radius:12px; box-shadow: var(--shadow); z-index:99;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(0)}
    .role-badge{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:#1f2937; background:#f3f4f6}
    .online-dot{width:8px; height:8px; border-radius:50%; background:var(--ok); display:inline-block; margin-right:6px}
    /* Back 버튼 */
    .back{
      display:inline-flex; align-items:center; gap:8px; background:#fff; color:#111;
      border:1px solid var(--border); border-radius:10px; padding:8px 12px; cursor:pointer;
    }
    .back svg{width:18px; height:18px}

    /* ====== 관리자 상세 전광판 스타일 ====== */
    .big .content{display:flex; justify-content:center}
    .reader{max-width:min(1400px, 94vw); margin:2vh auto 4vh; text-align:center}
    /* 제목은 적당히 크고 */
    .big h1{
      font-size:clamp(20px, 3.6vw, 44px);
      margin:0 0 8px 0; line-height:1.2; letter-spacing:.4px;
    }
    .big .meta{color:var(--muted); margin-bottom:18px; font-size:clamp(12px,1.6vw,16px)}
    /* 내용은 제목보다 훨~씬 크게 (전광판 느낌) */
    .big .body{
      font-size:clamp(28px, 6.8vw, 96px);  /* ← 내용이 더 큼 */
      line-height:1.25;
      white-space:pre-wrap;
      letter-spacing:.3px;
      text-align:center;
      margin-top:10px;
      /* 은은한 텍스트 그림자로 가독성 + 전광판 느낌 */
      text-shadow: 0 1px 0 rgba(255,255,255,.6), 0 6px 20px rgba(37,99,235,.08);
    }
    /* 상세 카드만 부드러운 그라데이션 배경 */
    #adminReadView .card{
      background:
        radial-gradient(900px 600px at 20% 0%, #eef2ff 0%, transparent 60%),
        radial-gradient(900px 600px at 80% 100%, #ecfdf5 0%, transparent 60%),
        var(--card);
      border-color:#e6e9f5;
    }
  </style>

  <!--
    ⚠️ 테스트/지인용 규칙(무인증)
    Firestore Rules → 아래를 Publish 해야 동작합니다 (운영용X)
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /{document=**} { allow read, write: if true; }
      }
    }
  -->

  <!-- Firebase SDK -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <i></i>
        <div>
          <div><b>롤링페이퍼</b> <span class="tag">실시간 · 밝은테마</span></div>
          <div class="sub">이름으로 접속 · 다른 사람에게만 작성 · 내 글만 관리 · 관리자 열람</div>
        </div>
      </div>
      <div id="statusArea" class="sub"></div>
    </header>

    <!-- 로그인 -->
    <section id="loginView" class="card section">
      <div class="h">입장하기</div>
      <div class="section">
        <div class="row" style="margin-top:10px">
          <input id="nameInput" type="text" placeholder="이름" maxlength="24" />
          <button id="enterBtn">입장</button>
        </div>
        <div class="note" style="margin-top:12px">
          • 이 버전은 인증 없이 누구나 접속 가능합니다.
        </div>
      </div>
    </section>

    <!-- 메인 -->
    <section id="mainView" class="hidden">
      <div class="card">
        <div class="topbar">
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
            <button class="back" id="backFromMain">
              <svg viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              뒤로가기
            </button>
            <span id="hello"></span>
            <span id="roleBadge" class="role-badge"></span>
          </div>
          <div class="row">
            <input id="filterInput" type="text" placeholder="이름 검색…" />
            <button id="resetBtn" class="danger hidden">전체 초기화(글+참가자)</button>
            <button id="logoutBtn" class="outline">나가기</button>
          </div>
        </div>
        <div class="content">
          <div id="peopleGrid" class="grid"></div>
        </div>
      </div>
    </section>

    <!-- 글쓰기/수정 -->
    <section id="writeView" class="hidden">
      <div class="card">
        <div class="topbar">
          <button class="back" id="backWrite">
            <svg viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            뒤로가기
          </button>
          <div class="h" id="writeTitle">롤링페이퍼 작성</div>
          <div></div>
        </div>
        <div class="content">
          <div class="sub" style="margin-bottom:8px"><span id="writeTargetLabel"></span></div>
          <input id="paperTitle" type="text" placeholder="제목" />
          <div style="height:10px"></div>
          <textarea id="paperContent" placeholder="내용"></textarea>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
            <button class="outline" id="cancelWrite">취소</button>
            <button id="savePaperBtn">저장</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 내 글 관리 -->
    <section id="manageView" class="hidden">
      <div class="card">
        <div class="topbar">
          <button class="back" id="backManage">
            <svg viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            뒤로가기
          </button>
          <div class="h">내 글 관리</div>
          <div></div>
        </div>
        <div class="content">
          <div class="sub" style="margin-bottom:10px"><span id="manageTargetLabel"></span>에 대해 내가 쓴 글 목록</div>
          <div id="myList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- 관리자 - 제목 목록 -->
    <section id="adminListView" class="hidden">
      <div class="card">
        <div class="topbar">
          <button class="back" id="backAdminList">
            <svg viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            뒤로가기
          </button>
          <div class="h"><span id="adminTargetName"></span>님에게 쓰인 글 (제목만)</div>
          <div></div>
        </div>
        <div class="content">
          <div class="sub" style="margin-bottom:8px">• 목록은 <b>제목만</b> 표시합니다. 제목을 누르면 큰 화면으로 열립니다.</div>
          <div id="adminTitleList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- 관리자 - 단일 글 크게 보기 (전광판) -->
    <section id="adminReadView" class="hidden">
      <div class="card big">
        <div class="topbar">
          <button class="back" id="backAdminRead">
            <svg viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            뒤로가기
          </button>
          <div class="h">글 상세</div>
          <div></div>
        </div>
        <div class="content">
          <div class="reader">
            <h1 id="adminReadTitle"></h1>
            <div class="meta" id="adminReadMeta"></div>
            <div class="body" id="adminReadContent"></div>
          </div>
        </div>
      </div>
    </section>

    <div id="toast" class="toast"></div>
  </div>

  <!-- 🔧 Firebase 설정 -->
  <script>
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyA2sTHW22VtoAIXd2P8b9Nift0c-WPSLdM",
      authDomain: "rolling-7519c.firebaseapp.com",
      projectId: "rolling-7519c",
      storageBucket: "rolling-7519c.firebasestorage.app",
      messagingSenderId: "663780806800",
      appId: "1:663780806800:web:f6f6f850fd926eeb42c815"
    };
  </script>

  <script>
  // ===== 유틸 =====
  const $ = s => document.querySelector(s);
  const toast = (m,ms=2000)=>{ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),ms); }
  const toMillis = v => (v?.toDate?.() ? v.toDate().getTime() : (typeof v==='number'?v:(isNaN(new Date(v))?0:+new Date(v))));
  const formatDT = ts => new Date(ts||Date.now()).toLocaleString();

  // ===== 상태 & 라우팅 =====
  const state = { user:null, role:'user', filter:'', view:'login' };
  const viewIds = ['loginView','mainView','writeView','manageView','adminListView','adminReadView'];
  const stack = [];
  const goTo = (id, push=true)=>{
    viewIds.forEach(v=>document.getElementById(v).classList.toggle('hidden', v!==id));
    if(push) stack.push(state.view);
    state.view = id;
  };
  const goBack = ()=>{
    const prev = stack.pop();
    if(!prev){ if(state.view!=='loginView'){ goTo('loginView',false);} return; }
    goTo(prev,false);
  };

  // ===== Firestore (무인증) =====
  class Store {
    constructor(cfg){
      if(!window.firebase || !firebase.initializeApp){
        throw new Error('Firebase SDK가 아직 로드되지 않았습니다.');
      }
      this.app = (firebase.apps && firebase.apps.length) ? firebase.app() : firebase.initializeApp(cfg);
      this.db = this.app.firestore();
      this.uid = localStorage.getItem('anonUid') || this._id();
      localStorage.setItem('anonUid', this.uid);
      window.addEventListener('beforeunload', ()=>this._presence(false).catch(()=>{}));
    }
    _id(){ return (crypto.randomUUID?.() ?? (Math.random().toString(36).slice(2)+Date.now().toString(36))); }
    colParticipants(){ return this.db.collection('participants'); }
    colPapers(){ return this.db.collection('papers'); }

    async signIn(name){
      this.name = name;
      if(!['Master','mMaster'].includes(name)){
        await this.colParticipants().doc(name).set({
          name, uid:this.uid, online:true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastActive: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
      }
      return {uid:this.uid, name};
    }
    async _presence(online){
      if(!this.name || ['Master','mMaster'].includes(this.name)) return;
      await this.colParticipants().doc(this.name).set({
        online, lastActive: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    }
    async signOut(){ await this._presence(false); }

    onPeopleChanged(cb){
      const update = async ()=>{
        const [pSnap, papersSnap] = await Promise.all([ this.colParticipants().get(), this.colPapers().get() ]);
        const mine = this.name;
        const arr = pSnap.docs.map(d=>({name:d.id, ...(d.data()||{})}));
        const all = papersSnap.docs.map(d=>d.data());
        for(const person of arr){
          person.countTotal = all.filter(x=>x.to===person.name).length;
          person.countMine  = all.filter(x=>x.to===person.name && x.authorName===mine).length;
          if(typeof person.online!=='boolean') person.online=false;
        }
        arr.sort((a,b)=> a.name.localeCompare(b.name,'ko'));
        cb(arr);
      };
      this.colParticipants().onSnapshot(update);
      this.colPapers().onSnapshot(update);
    }

    async ensurePerson(name){
      const d = await this.colParticipants().doc(name).get();
      if(!d.exists && !['Master','mMaster'].includes(name)){
        await this.colParticipants().doc(name).set({name, online:false, createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      }
    }

    async createPaper({to, authorName, title, content}){
      const ref = await this.colPapers().add({
        to, authorName, authorUid:this.uid, title, content,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      return {id:ref.id, to, authorName, title, content};
    }
    async listMyPapersTo(to, authorName){
      const snap = await this.colPapers().where('to','==',to).where('authorName','==',authorName).get();
      const arr = snap.docs.map(d=>({id:d.id, ...d.data()}));
      arr.sort((a,b)=> (toMillis(b.updatedAt)||toMillis(b.createdAt)) - (toMillis(a.updatedAt)||toMillis(a.createdAt)));
      return arr;
    }
    async listAllTo(to){
      const snap = await this.colPapers().where('to','==',to).get();
      const arr = snap.docs.map(d=>({id:d.id, ...d.data()}));
      arr.sort((a,b)=> (toMillis(b.updatedAt)||toMillis(b.createdAt)) - (toMillis(a.updatedAt)||toMillis(a.createdAt)));
      return arr;
    }
    async getPaper(id){
      const d = await this.colPapers().doc(id).get();
      return {id, ...(d.data()||{})};
    }
    async updatePaper(id, data){
      await this.colPapers().doc(id).update({...data, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
    }
    async deletePaper(id){ await this.colPapers().doc(id).delete(); }

    async resetAll(){ // 글 + 참가자 전체 삭제
      let p=0,u=0;
      while(true){
        const s=await this.colPapers().limit(450).get(); if(s.empty) break;
        const b=this.db.batch(); s.docs.forEach(d=>b.delete(d.ref)); await b.commit(); p+=s.docs.length;
      }
      while(true){
        const s=await this.colParticipants().limit(450).get(); if(s.empty) break;
        const b=this.db.batch(); s.docs.forEach(d=>b.delete(d.ref)); await b.commit(); u+=s.docs.length;
      }
      return {papers:p, participants:u};
    }
  }

  // ===== 전역 =====
  let store=null, currentTarget=null, editingPaperId=null, peopleCache=[];

  function roleOf(name){ if(name==='Master') return 'master'; if(name==='mMaster') return 'mmaster'; return 'user'; }
  const isAdmin = ()=> state.role==='master' || state.role==='mmaster';

  function applyRoleUI(){
    document.getElementById('hello').innerHTML = `<span class="online-dot"></span><b>${state.user?.name}</b> 님 환영합니다!`;
    document.getElementById('roleBadge').textContent = isAdmin() ? '관리자' : '일반 사용자';
    document.getElementById('resetBtn').classList.toggle('hidden', state.role!=='mmaster');
  }

  async function refreshPeople(){
    const f=(state.filter||'').trim().toLowerCase();
    const list=peopleCache.filter(p=>!f||p.name.toLowerCase().includes(f));
    const grid = document.getElementById('peopleGrid'); grid.innerHTML='';
    if(list.length===0){ grid.innerHTML='<div class="sub" style="padding:40px;text-align:center;color:var(--muted)">아직 참가자가 없습니다.</div>'; return;}
    const me = state.user?.name;
    for(const person of list){
      const el=document.createElement('div'); el.className='person card';
      el.innerHTML=`
        <span class="pill">${person.online?'온라인':'오프라인'}</span>
        <div class="h">${person.name}</div>
        <div class="counts">
          <span>전체 ${person.countTotal??0}</span>
          <span>내 글 ${person.countMine??0}</span>
        </div>
        <div class="toolbar">
          <button ${person.name===me?'disabled':''} data-act="write">쓰기</button>
          <button class="outline" ${person.name===me?'disabled':''} data-act="manage">수정·삭제</button>
          ${isAdmin()?`<button class="ok" data-act="admin">관리자 열람</button>`:''}
        </div>`;
      el.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const act=btn.dataset.act;
          if((act==='write'||act==='manage') && person.name===me){ toast('자기 자신의 페이지에는 들어갈 수 없습니다.'); return; }
          if(act==='write'){ currentTarget=person.name; openWrite({mode:'create'}); }
          if(act==='manage'){ currentTarget=person.name; openManage(person.name); }
          if(act==='admin'){ openAdminList(person.name); }
        });
      });
      grid.appendChild(el);
    }
  }

  function openWrite({mode, paper}){
    document.getElementById('writeTitle').textContent = mode==='edit' ? '롤링페이퍼 수정' : '롤링페이퍼 작성';
    document.getElementById('writeTargetLabel').textContent = `대상: ${currentTarget}`;
    editingPaperId = mode==='edit' ? paper.id : null;
    document.getElementById('paperTitle').value = paper?.title || '';
    document.getElementById('paperContent').value = paper?.content || '';
    goTo('writeView');
  }

  async function openManage(target){
    document.getElementById('manageTargetLabel').textContent = `대상 ${target}`;
    const list = await store.listMyPapersTo(target, state.user.name);
    const box = document.getElementById('myList'); box.innerHTML='';
    if(list.length===0){
      box.innerHTML='<div class="item sub" style="text-align:center">아직 작성한 글이 없습니다.</div>';
    }else{
      for(const p of list){
        const el=document.createElement('div'); el.className='item';
        const ts=formatDT(toMillis(p.updatedAt)||toMillis(p.createdAt));
        el.innerHTML=`
          <b>${p.title||'(제목 없음)'}</b>
          <div class="sub" style="margin-bottom:8px">${ts}</div>
          <div style="white-space:pre-wrap">${p.content||''}</div>
          <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end">
            <button class="outline" data-act="edit">수정</button>
            <button class="danger" data-act="del">삭제</button>
          </div>`;
        el.querySelector('[data-act="edit"]').onclick=()=>{ currentTarget=target; openWrite({mode:'edit', paper:p}); };
        el.querySelector('[data-act="del"]').onclick=async ()=>{
          if(confirm('이 글을 삭제할까요?')){
            try{ await store.deletePaper(p.id); toast('삭제되었습니다.'); openManage(target); }catch(e){ toast('삭제 실패: '+(e.message||e.code)); }
          }
        };
        box.appendChild(el);
      }
    }
    goTo('manageView');
  }

  async function openAdminList(target){
    document.getElementById('adminTargetName').textContent = target;
    try{
      const list = await store.listAllTo(target);
      const box = document.getElementById('adminTitleList'); box.innerHTML='';
      if(list.length===0){
        box.innerHTML='<div class="item sub" style="text-align:center">아직 글이 없습니다.</div>';
      }else{
        list.forEach(p=>{
          const el=document.createElement('div'); el.className='item';
          el.innerHTML=`<button class="ghost" data-id="${p.id}" style="text-align:left; width:100%; font-weight:700">${p.title||'(제목 없음)'}</button>`;
          el.querySelector('button').onclick=()=>openAdminRead(p.id);
          box.appendChild(el);
        });
      }
      goTo('adminListView');
    }catch(e){ toast('관리자 열람 실패: '+(e.message||e.code)); }
  }

  async function openAdminRead(paperId){
    try{
      const p = await store.getPaper(paperId);
      const showAuthor = (state.role==='mmaster'); // 최고 권한만 작성자 표시
      const metaParts = [];
      if(showAuthor) metaParts.push(`작성자: ${p.authorName || '알 수 없음'}`);
      metaParts.push(formatDT(toMillis(p.updatedAt)||toMillis(p.createdAt)));

      document.getElementById('adminReadTitle').textContent = p.title||'(제목 없음)';
      document.getElementById('adminReadMeta').textContent = metaParts.join(' · ');
      document.getElementById('adminReadContent').textContent = p.content||'';
      goTo('adminReadView');
    }catch(e){ toast('글을 불러오지 못했습니다: '+(e.message||e.code)); }
  }

  function initApp(){
    try{
      if (!window.FIREBASE_CONFIG || !window.FIREBASE_CONFIG.apiKey) {
        throw new Error('FIREBASE_CONFIG 누락 또는 잘못된 설정');
      }
      window.store = new Store(window.FIREBASE_CONFIG);
      document.getElementById('statusArea').innerHTML = `백엔드: <b>Firestore</b> 연결 준비 · <span class="sub">인증 없음(지인용)</span>`;
    }catch(e){
      console.error(e);
      document.getElementById('statusArea').innerHTML = `<span style="color:#b91c1c">Firebase 초기화 실패:</span> <span class="sub">${e.message || e.code || '알 수 없는 오류'}</span>`;
      return;
    }

    document.getElementById('enterBtn').addEventListener('click', async ()=>{
      const name = (document.getElementById('nameInput').value||'').trim();
      if(!name){ toast('이름을 입력해 주세요'); return; }
      state.role = roleOf(name);
      try{
        await store.signIn(name);
        await store.ensurePerson(name);
        state.user = { name };
        applyRoleUI();
        store.onPeopleChanged(list=>{ peopleCache=list; refreshPeople(); });
        goTo('mainView');
        toast('입장했습니다.');
      }catch(e){ console.error(e); toast('입장 실패: '+(e.message||e.code)); }
    });

    document.getElementById('logoutBtn').addEventListener('click', async ()=>{ try{ await store.signOut(); }catch{} location.reload(); });
    document.getElementById('filterInput').addEventListener('input', e=>{ state.filter=e.target.value; refreshPeople(); });
    document.getElementById('resetBtn').addEventListener('click', async ()=>{
      if(state.role!=='mmaster') return;
      const phrase='전체 초기화';
      const input=prompt(`정말 모든 글과 참가자 목록을 삭제할까요?\n되돌릴 수 없습니다!\n확인 문구: ${phrase}`);
      if(input!==phrase){ toast('취소되었습니다.'); return; }
      try{ const {papers,participants}=await store.resetAll(); toast(`초기화 완료: 글 ${papers} · 참가자 ${participants}`); }
      catch(e){ toast('초기화 중 오류: '+(e.message||e.code)); }
    });

    // 뒤로가기
    document.getElementById('backFromMain').addEventListener('click', async ()=>{ try{ await store.signOut(); }catch{} goTo('loginView'); stack.length=0; });
    document.getElementById('backWrite').addEventListener('click', goBack);
    document.getElementById('cancelWrite').addEventListener('click', goBack);
    document.getElementById('backManage').addEventListener('click', goBack);
    document.getElementById('backAdminList').addEventListener('click', goBack);
    document.getElementById('backAdminRead').addEventListener('click', goBack);

    // 저장
    document.getElementById('savePaperBtn').addEventListener('click', async ()=>{
      const title=(document.getElementById('paperTitle').value||'').trim();
      const content=(document.getElementById('paperContent').value||'').trim();
      if(!currentTarget){ toast('대상이 없습니다.'); return; }
      if(!title||!content){ toast('제목과 내용을 입력해 주세요'); return; }
      try{
        if(editingPaperId){ await store.updatePaper(editingPaperId,{title,content}); toast('수정되었습니다.'); }
        else{ await store.createPaper({to:currentTarget, authorName: state.user.name, title, content}); toast('저장되었습니다.'); }
        goBack();
      }catch(e){ toast('저장 중 오류: '+(e.message||e.code)); }
    });
  }
  window.addEventListener('load', initApp);
  </script>
</body>
</html>
