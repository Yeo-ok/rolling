<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¡¤ë§í˜ì´í¼</title>
  <style>
    :root{
      --bg:#ffffff; --text:#111827; --muted:#6b7280;
      --card:#ffffff; --border:#e5e7eb; --soft:#f8fafc;
      --accent:#2563eb; --accent-2:#10b981;
      --danger:#ef4444; --warning:#f59e0b; --ok:#16a34a;
      --shadow:0 8px 20px rgba(0,0,0,.06); --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      /* íŒŒìŠ¤í…” ë³´ì¼€ ëŠë‚Œ ë°°ê²½ */
      background:
        radial-gradient(1200px 900px at -10% -10%, #e0f2ff 0%, transparent 60%),
        radial-gradient(900px 700px at 110% -10%, #fef3c7 0%, transparent 55%),
        radial-gradient(900px 700px at 50% 120%, #dcfce7 0%, transparent 55%),
        linear-gradient(#ffffff,#ffffff);
      background-attachment: fixed;
      overflow-x:hidden;
    }
    /* ì‚´ì§ ì›€ì§ì´ëŠ” ë°°ê²½ ì¡°ëª… */
    @keyframes floatGlow {
      0% { filter:saturate(110%) brightness(102%); }
      50%{ filter:saturate(120%) brightness(105%); }
      100%{ filter:saturate(110%) brightness(102%); }
    }
    body::after{
      content:""; position:fixed; inset:-10% -10% -10% -10%; z-index:-1; pointer-events:none;
      background:
        radial-gradient(40vw 30vw at 20% 20%, rgba(99,102,241,.10), transparent 60%),
        radial-gradient(45vw 35vw at 80% 15%, rgba(16,185,129,.10), transparent 60%),
        radial-gradient(60vw 45vw at 50% 85%, rgba(250,204,21,.10), transparent 60%);
      animation: floatGlow 10s ease-in-out infinite;
    }

    a{color:var(--accent); text-decoration:none}
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px;}
    .logo{display:flex; gap:10px; align-items:center}
    .logo i{width:36px; height:36px; background:linear-gradient(135deg,#60a5fa,#34d399); border-radius:10px; box-shadow:var(--shadow)}
    .tag{padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px; background:var(--soft)}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);}
    .section{padding:16px}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 16px; border-bottom:1px solid var(--border); background:var(--soft); border-top-left-radius:var(--radius); border-top-right-radius:var(--radius)}
    .content{padding:16px}
    .h{font-size:20px; font-weight:800}
    .sub{font-size:13px; color:var(--muted)}
    .grid{display:grid; gap:14px; grid-template-columns: repeat( auto-fill, minmax(230px, 1fr) );}
    .person{padding:16px; display:flex; flex-direction:column; gap:10px; position:relative}
    .counts{display:flex; gap:10px; color:var(--muted); font-size:12px}
    .counts span{padding:4px 8px; border-radius:999px; background:var(--soft); border:1px solid var(--border)}
    .pill{position:absolute; right:10px; top:10px; font-size:11px; color:#0b7; padding:4px 8px; border-radius:999px; background:#ecfeff; border:1px solid #99f}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .hidden{display:none !important}
    .row{display:flex; gap:10px; align-items:center}
    input[type=text], textarea{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid var(--border); background:#fff; color:var(--text); outline:none; transition:.15s;
    }
    input[type=text]:focus, textarea:focus{border-color:#93c5fd; box-shadow:0 0 0 4px #dbeafe}
    textarea{min-height:140px; resize:vertical; line-height:1.5}
    button{
      border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:700;
      background:var(--accent); color:white; box-shadow:var(--shadow); transition:.12s;
    }
    button.outline{background:#fff; border:1px solid var(--border); color:var(--text)}
    button.ghost{background:transparent; color:var(--muted); box-shadow:none}
    button.danger{background:var(--danger)} button.ok{background:var(--accent-2); color:#064e3b}
    button:disabled{opacity:.5; cursor:not-allowed}
    .note{padding:10px 12px; background:var(--soft); border:1px solid var(--border); border-radius:12px; color:#374151}
    .toast{
      position: fixed; left:50%; bottom: 22px; transform: translateX(-50%) translateY(20px);
      transition:.25s; opacity:0; background:#111827; color:white; border:1px solid rgba(255,255,255,.08);
      padding:10px 14px; border-radius:12px; box-shadow: var(--shadow); z-index:99;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(0)}
    .role-badge{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:#1f2937; background:#f3f4f6}
    .online-dot{width:8px; height:8px; border-radius:50%; background:var(--ok); display:inline-block; margin-right:6px}
    /* Back ë²„íŠ¼ */
    .back{
      display:inline-flex; align-items:center; gap:8px; background:#fff; color:#111;
      border:1px solid var(--border); border-radius:10px; padding:8px 12px; cursor:pointer;
    }
    .back svg{width:18px; height:18px}

    /* ====== ê´€ë¦¬ì ìƒì„¸ ì „ê´‘íŒ ìŠ¤íƒ€ì¼ ====== */
    .big .content{display:flex; justify-content:center}
    .reader{max-width:min(1400px, 94vw); margin:2vh auto 4vh; text-align:center}
    /* ì œëª©ì€ ì ë‹¹íˆ í¬ê³  */
    .big h1{
      font-size:clamp(20px, 3.6vw, 44px);
      margin:0 0 8px 0; line-height:1.2; letter-spacing:.4px;
    }
    .big .meta{color:var(--muted); margin-bottom:18px; font-size:clamp(12px,1.6vw,16px)}
    /* ë‚´ìš©ì€ ì œëª©ë³´ë‹¤ í›¨~ì”¬ í¬ê²Œ (ì „ê´‘íŒ ëŠë‚Œ) */
    .big .body{
      font-size:clamp(28px, 6.8vw, 96px);  /* â† ë‚´ìš©ì´ ë” í¼ */
      line-height:1.25;
      white-space:pre-wrap;
      letter-spacing:.3px;
      text-align:center;
      margin-top:10px;
      /* ì€ì€í•œ í…ìŠ¤íŠ¸ ê·¸ë¦¼ìë¡œ ê°€ë…ì„± + ì „ê´‘íŒ ëŠë‚Œ */
      text-shadow: 0 1px 0 rgba(255,255,255,.6), 0 6px 20px rgba(37,99,235,.08);
    }
    /* ìƒì„¸ ì¹´ë“œë§Œ ë¶€ë“œëŸ¬ìš´ ê·¸ë¼ë°ì´ì…˜ ë°°ê²½ */
    #adminReadView .card{
      background:
        radial-gradient(900px 600px at 20% 0%, #eef2ff 0%, transparent 60%),
        radial-gradient(900px 600px at 80% 100%, #ecfdf5 0%, transparent 60%),
        var(--card);
      border-color:#e6e9f5;
    }
  </style>

  <!--
    âš ï¸ í…ŒìŠ¤íŠ¸/ì§€ì¸ìš© ê·œì¹™(ë¬´ì¸ì¦)
    Firestore Rules â†’ ì•„ë˜ë¥¼ Publish í•´ì•¼ ë™ì‘í•©ë‹ˆë‹¤ (ìš´ì˜ìš©X)
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /{document=**} { allow read, write: if true; }
      }
    }
  -->

  <!-- Firebase SDK -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <i></i>
        <div>
          <div><b>ë¡¤ë§í˜ì´í¼</b> <span class="tag">ì‹¤ì‹œê°„ Â· ë°ì€í…Œë§ˆ</span></div>
          <div class="sub">ì´ë¦„ìœ¼ë¡œ ì ‘ì† Â· ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œë§Œ ì‘ì„± Â· ë‚´ ê¸€ë§Œ ê´€ë¦¬ Â· ê´€ë¦¬ì ì—´ëŒ</div>
        </div>
      </div>
      <div id="statusArea" class="sub"></div>
    </header>

    <!-- ë¡œê·¸ì¸ -->
    <section id="loginView" class="card section">
      <div class="h">ì…ì¥í•˜ê¸°</div>
      <div class="section">
        <div class="row" style="margin-top:10px">
          <input id="nameInput" type="text" placeholder="ì´ë¦„" maxlength="24" />
          <button id="enterBtn">ì…ì¥</button>
        </div>
        <div class="note" style="margin-top:12px">
          â€¢ ì´ ë²„ì „ì€ ì¸ì¦ ì—†ì´ ëˆ„êµ¬ë‚˜ ì ‘ì† ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </div>
      </div>
    </section>

    <!-- ë©”ì¸ -->
    <section id="mainView" class="hidden">
      <div class="card">
        <div class="topbar">
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
            <button class="back" id="backFromMain">
              <svg viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              ë’¤ë¡œê°€ê¸°
            </button>
            <span id="hello"></span>
            <span id="roleBadge" class="role-badge"></span>
          </div>
          <div class="row">
            <input id="filterInput" type="text" placeholder="ì´ë¦„ ê²€ìƒ‰â€¦" />
            <button id="resetBtn" class="danger hidden">ì „ì²´ ì´ˆê¸°í™”(ê¸€+ì°¸ê°€ì)</button>
            <button id="logoutBtn" class="outline">ë‚˜ê°€ê¸°</button>
          </div>
        </div>
        <div class="content">
          <div id="peopleGrid" class="grid"></div>
        </div>
      </div>
    </section>

    <!-- ê¸€ì“°ê¸°/ìˆ˜ì • -->
    <section id="writeView" class="hidden">
      <div class="card">
        <div class="topbar">
          <button class="back" id="backWrite">
            <svg viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            ë’¤ë¡œê°€ê¸°
          </button>
          <div class="h" id="writeTitle">ë¡¤ë§í˜ì´í¼ ì‘ì„±</div>
          <div></div>
        </div>
        <div class="content">
          <div class="sub" style="margin-bottom:8px"><span id="writeTargetLabel"></span></div>
          <input id="paperTitle" type="text" placeholder="ì œëª©" />
          <div style="height:10px"></div>
          <textarea id="paperContent" placeholder="ë‚´ìš©"></textarea>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
            <button class="outline" id="cancelWrite">ì·¨ì†Œ</button>
            <button id="savePaperBtn">ì €ì¥</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ë‚´ ê¸€ ê´€ë¦¬ -->
    <section id="manageView" class="hidden">
      <div class="card">
        <div class="topbar">
          <button class="back" id="backManage">
            <svg viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            ë’¤ë¡œê°€ê¸°
          </button>
          <div class="h">ë‚´ ê¸€ ê´€ë¦¬</div>
          <div></div>
        </div>
        <div class="content">
          <div class="sub" style="margin-bottom:10px"><span id="manageTargetLabel"></span>ì— ëŒ€í•´ ë‚´ê°€ ì“´ ê¸€ ëª©ë¡</div>
          <div id="myList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- ê´€ë¦¬ì - ì œëª© ëª©ë¡ -->
    <section id="adminListView" class="hidden">
      <div class="card">
        <div class="topbar">
          <button class="back" id="backAdminList">
            <svg viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            ë’¤ë¡œê°€ê¸°
          </button>
          <div class="h"><span id="adminTargetName"></span>ë‹˜ì—ê²Œ ì“°ì¸ ê¸€ (ì œëª©ë§Œ)</div>
          <div></div>
        </div>
        <div class="content">
          <div class="sub" style="margin-bottom:8px">â€¢ ëª©ë¡ì€ <b>ì œëª©ë§Œ</b> í‘œì‹œí•©ë‹ˆë‹¤. ì œëª©ì„ ëˆ„ë¥´ë©´ í° í™”ë©´ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.</div>
          <div id="adminTitleList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- ê´€ë¦¬ì - ë‹¨ì¼ ê¸€ í¬ê²Œ ë³´ê¸° (ì „ê´‘íŒ) -->
    <section id="adminReadView" class="hidden">
      <div class="card big">
        <div class="topbar">
          <button class="back" id="backAdminRead">
            <svg viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            ë’¤ë¡œê°€ê¸°
          </button>
          <div class="h">ê¸€ ìƒì„¸</div>
          <div></div>
        </div>
        <div class="content">
          <div class="reader">
            <h1 id="adminReadTitle"></h1>
            <div class="meta" id="adminReadMeta"></div>
            <div class="body" id="adminReadContent"></div>
          </div>
        </div>
      </div>
    </section>

    <div id="toast" class="toast"></div>
  </div>

  <!-- ğŸ”§ Firebase ì„¤ì • -->
  <script>
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyA2sTHW22VtoAIXd2P8b9Nift0c-WPSLdM",
      authDomain: "rolling-7519c.firebaseapp.com",
      projectId: "rolling-7519c",
      storageBucket: "rolling-7519c.firebasestorage.app",
      messagingSenderId: "663780806800",
      appId: "1:663780806800:web:f6f6f850fd926eeb42c815"
    };
  </script>

  <script>
  // ===== ìœ í‹¸ =====
  const $ = s => document.querySelector(s);
  const toast = (m,ms=2000)=>{ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),ms); }
  const toMillis = v => (v?.toDate?.() ? v.toDate().getTime() : (typeof v==='number'?v:(isNaN(new Date(v))?0:+new Date(v))));
  const formatDT = ts => new Date(ts||Date.now()).toLocaleString();

  // ===== ìƒíƒœ & ë¼ìš°íŒ… =====
  const state = { user:null, role:'user', filter:'', view:'login' };
  const viewIds = ['loginView','mainView','writeView','manageView','adminListView','adminReadView'];
  const stack = [];
  const goTo = (id, push=true)=>{
    viewIds.forEach(v=>document.getElementById(v).classList.toggle('hidden', v!==id));
    if(push) stack.push(state.view);
    state.view = id;
  };
  const goBack = ()=>{
    const prev = stack.pop();
    if(!prev){ if(state.view!=='loginView'){ goTo('loginView',false);} return; }
    goTo(prev,false);
  };

  // ===== Firestore (ë¬´ì¸ì¦) =====
  class Store {
    constructor(cfg){
      if(!window.firebase || !firebase.initializeApp){
        throw new Error('Firebase SDKê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      }
      this.app = (firebase.apps && firebase.apps.length) ? firebase.app() : firebase.initializeApp(cfg);
      this.db = this.app.firestore();
      this.uid = localStorage.getItem('anonUid') || this._id();
      localStorage.setItem('anonUid', this.uid);
      window.addEventListener('beforeunload', ()=>this._presence(false).catch(()=>{}));
    }
    _id(){ return (crypto.randomUUID?.() ?? (Math.random().toString(36).slice(2)+Date.now().toString(36))); }
    colParticipants(){ return this.db.collection('participants'); }
    colPapers(){ return this.db.collection('papers'); }

    async signIn(name){
      this.name = name;
      if(!['Master','mMaster'].includes(name)){
        await this.colParticipants().doc(name).set({
          name, uid:this.uid, online:true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastActive: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
      }
      return {uid:this.uid, name};
    }
    async _presence(online){
      if(!this.name || ['Master','mMaster'].includes(this.name)) return;
      await this.colParticipants().doc(this.name).set({
        online, lastActive: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    }
    async signOut(){ await this._presence(false); }

    onPeopleChanged(cb){
      const update = async ()=>{
        const [pSnap, papersSnap] = await Promise.all([ this.colParticipants().get(), this.colPapers().get() ]);
        const mine = this.name;
        const arr = pSnap.docs.map(d=>({name:d.id, ...(d.data()||{})}));
        const all = papersSnap.docs.map(d=>d.data());
        for(const person of arr){
          person.countTotal = all.filter(x=>x.to===person.name).length;
          person.countMine  = all.filter(x=>x.to===person.name && x.authorName===mine).length;
          if(typeof person.online!=='boolean') person.online=false;
        }
        arr.sort((a,b)=> a.name.localeCompare(b.name,'ko'));
        cb(arr);
      };
      this.colParticipants().onSnapshot(update);
      this.colPapers().onSnapshot(update);
    }

    async ensurePerson(name){
      const d = await this.colParticipants().doc(name).get();
      if(!d.exists && !['Master','mMaster'].includes(name)){
        await this.colParticipants().doc(name).set({name, online:false, createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      }
    }

    async createPaper({to, authorName, title, content}){
      const ref = await this.colPapers().add({
        to, authorName, authorUid:this.uid, title, content,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      return {id:ref.id, to, authorName, title, content};
    }
    async listMyPapersTo(to, authorName){
      const snap = await this.colPapers().where('to','==',to).where('authorName','==',authorName).get();
      const arr = snap.docs.map(d=>({id:d.id, ...d.data()}));
      arr.sort((a,b)=> (toMillis(b.updatedAt)||toMillis(b.createdAt)) - (toMillis(a.updatedAt)||toMillis(a.createdAt)));
      return arr;
    }
    async listAllTo(to){
      const snap = await this.colPapers().where('to','==',to).get();
      const arr = snap.docs.map(d=>({id:d.id, ...d.data()}));
      arr.sort((a,b)=> (toMillis(b.updatedAt)||toMillis(b.createdAt)) - (toMillis(a.updatedAt)||toMillis(a.createdAt)));
      return arr;
    }
    async getPaper(id){
      const d = await this.colPapers().doc(id).get();
      return {id, ...(d.data()||{})};
    }
    async updatePaper(id, data){
      await this.colPapers().doc(id).update({...data, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
    }
    async deletePaper(id){ await this.colPapers().doc(id).delete(); }

    async resetAll(){ // ê¸€ + ì°¸ê°€ì ì „ì²´ ì‚­ì œ
      let p=0,u=0;
      while(true){
        const s=await this.colPapers().limit(450).get(); if(s.empty) break;
        const b=this.db.batch(); s.docs.forEach(d=>b.delete(d.ref)); await b.commit(); p+=s.docs.length;
      }
      while(true){
        const s=await this.colParticipants().limit(450).get(); if(s.empty) break;
        const b=this.db.batch(); s.docs.forEach(d=>b.delete(d.ref)); await b.commit(); u+=s.docs.length;
      }
      return {papers:p, participants:u};
    }
  }

  // ===== ì „ì—­ =====
  let store=null, currentTarget=null, editingPaperId=null, peopleCache=[];

  function roleOf(name){ if(name==='Master') return 'master'; if(name==='mMaster') return 'mmaster'; return 'user'; }
  const isAdmin = ()=> state.role==='master' || state.role==='mmaster';

  function applyRoleUI(){
    document.getElementById('hello').innerHTML = `<span class="online-dot"></span><b>${state.user?.name}</b> ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
    document.getElementById('roleBadge').textContent = isAdmin() ? 'ê´€ë¦¬ì' : 'ì¼ë°˜ ì‚¬ìš©ì';
    document.getElementById('resetBtn').classList.toggle('hidden', state.role!=='mmaster');
  }

  async function refreshPeople(){
    const f=(state.filter||'').trim().toLowerCase();
    const list=peopleCache.filter(p=>!f||p.name.toLowerCase().includes(f));
    const grid = document.getElementById('peopleGrid'); grid.innerHTML='';
    if(list.length===0){ grid.innerHTML='<div class="sub" style="padding:40px;text-align:center;color:var(--muted)">ì•„ì§ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return;}
    const me = state.user?.name;
    for(const person of list){
      const el=document.createElement('div'); el.className='person card';
      el.innerHTML=`
        <span class="pill">${person.online?'ì˜¨ë¼ì¸':'ì˜¤í”„ë¼ì¸'}</span>
        <div class="h">${person.name}</div>
        <div class="counts">
          <span>ì „ì²´ ${person.countTotal??0}</span>
          <span>ë‚´ ê¸€ ${person.countMine??0}</span>
        </div>
        <div class="toolbar">
          <button ${person.name===me?'disabled':''} data-act="write">ì“°ê¸°</button>
          <button class="outline" ${person.name===me?'disabled':''} data-act="manage">ìˆ˜ì •Â·ì‚­ì œ</button>
          ${isAdmin()?`<button class="ok" data-act="admin">ê´€ë¦¬ì ì—´ëŒ</button>`:''}
        </div>`;
      el.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const act=btn.dataset.act;
          if((act==='write'||act==='manage') && person.name===me){ toast('ìê¸° ìì‹ ì˜ í˜ì´ì§€ì—ëŠ” ë“¤ì–´ê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
          if(act==='write'){ currentTarget=person.name; openWrite({mode:'create'}); }
          if(act==='manage'){ currentTarget=person.name; openManage(person.name); }
          if(act==='admin'){ openAdminList(person.name); }
        });
      });
      grid.appendChild(el);
    }
  }

  function openWrite({mode, paper}){
    document.getElementById('writeTitle').textContent = mode==='edit' ? 'ë¡¤ë§í˜ì´í¼ ìˆ˜ì •' : 'ë¡¤ë§í˜ì´í¼ ì‘ì„±';
    document.getElementById('writeTargetLabel').textContent = `ëŒ€ìƒ: ${currentTarget}`;
    editingPaperId = mode==='edit' ? paper.id : null;
    document.getElementById('paperTitle').value = paper?.title || '';
    document.getElementById('paperContent').value = paper?.content || '';
    goTo('writeView');
  }

  async function openManage(target){
    document.getElementById('manageTargetLabel').textContent = `ëŒ€ìƒ ${target}`;
    const list = await store.listMyPapersTo(target, state.user.name);
    const box = document.getElementById('myList'); box.innerHTML='';
    if(list.length===0){
      box.innerHTML='<div class="item sub" style="text-align:center">ì•„ì§ ì‘ì„±í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }else{
      for(const p of list){
        const el=document.createElement('div'); el.className='item';
        const ts=formatDT(toMillis(p.updatedAt)||toMillis(p.createdAt));
        el.innerHTML=`
          <b>${p.title||'(ì œëª© ì—†ìŒ)'}</b>
          <div class="sub" style="margin-bottom:8px">${ts}</div>
          <div style="white-space:pre-wrap">${p.content||''}</div>
          <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end">
            <button class="outline" data-act="edit">ìˆ˜ì •</button>
            <button class="danger" data-act="del">ì‚­ì œ</button>
          </div>`;
        el.querySelector('[data-act="edit"]').onclick=()=>{ currentTarget=target; openWrite({mode:'edit', paper:p}); };
        el.querySelector('[data-act="del"]').onclick=async ()=>{
          if(confirm('ì´ ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')){
            try{ await store.deletePaper(p.id); toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); openManage(target); }catch(e){ toast('ì‚­ì œ ì‹¤íŒ¨: '+(e.message||e.code)); }
          }
        };
        box.appendChild(el);
      }
    }
    goTo('manageView');
  }

  async function openAdminList(target){
    document.getElementById('adminTargetName').textContent = target;
    try{
      const list = await store.listAllTo(target);
      const box = document.getElementById('adminTitleList'); box.innerHTML='';
      if(list.length===0){
        box.innerHTML='<div class="item sub" style="text-align:center">ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      }else{
        list.forEach(p=>{
          const el=document.createElement('div'); el.className='item';
          el.innerHTML=`<button class="ghost" data-id="${p.id}" style="text-align:left; width:100%; font-weight:700">${p.title||'(ì œëª© ì—†ìŒ)'}</button>`;
          el.querySelector('button').onclick=()=>openAdminRead(p.id);
          box.appendChild(el);
        });
      }
      goTo('adminListView');
    }catch(e){ toast('ê´€ë¦¬ì ì—´ëŒ ì‹¤íŒ¨: '+(e.message||e.code)); }
  }

  async function openAdminRead(paperId){
    try{
      const p = await store.getPaper(paperId);
      const showAuthor = (state.role==='mmaster'); // ìµœê³  ê¶Œí•œë§Œ ì‘ì„±ì í‘œì‹œ
      const metaParts = [];
      if(showAuthor) metaParts.push(`ì‘ì„±ì: ${p.authorName || 'ì•Œ ìˆ˜ ì—†ìŒ'}`);
      metaParts.push(formatDT(toMillis(p.updatedAt)||toMillis(p.createdAt)));

      document.getElementById('adminReadTitle').textContent = p.title||'(ì œëª© ì—†ìŒ)';
      document.getElementById('adminReadMeta').textContent = metaParts.join(' Â· ');
      document.getElementById('adminReadContent').textContent = p.content||'';
      goTo('adminReadView');
    }catch(e){ toast('ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: '+(e.message||e.code)); }
  }

  function initApp(){
    try{
      if (!window.FIREBASE_CONFIG || !window.FIREBASE_CONFIG.apiKey) {
        throw new Error('FIREBASE_CONFIG ëˆ„ë½ ë˜ëŠ” ì˜ëª»ëœ ì„¤ì •');
      }
      window.store = new Store(window.FIREBASE_CONFIG);
      document.getElementById('statusArea').innerHTML = `ë°±ì—”ë“œ: <b>Firestore</b> ì—°ê²° ì¤€ë¹„ Â· <span class="sub">ì¸ì¦ ì—†ìŒ(ì§€ì¸ìš©)</span>`;
    }catch(e){
      console.error(e);
      document.getElementById('statusArea').innerHTML = `<span style="color:#b91c1c">Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:</span> <span class="sub">${e.message || e.code || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</span>`;
      return;
    }

    document.getElementById('enterBtn').addEventListener('click', async ()=>{
      const name = (document.getElementById('nameInput').value||'').trim();
      if(!name){ toast('ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
      state.role = roleOf(name);
      try{
        await store.signIn(name);
        await store.ensurePerson(name);
        state.user = { name };
        applyRoleUI();
        store.onPeopleChanged(list=>{ peopleCache=list; refreshPeople(); });
        goTo('mainView');
        toast('ì…ì¥í–ˆìŠµë‹ˆë‹¤.');
      }catch(e){ console.error(e); toast('ì…ì¥ ì‹¤íŒ¨: '+(e.message||e.code)); }
    });

    document.getElementById('logoutBtn').addEventListener('click', async ()=>{ try{ await store.signOut(); }catch{} location.reload(); });
    document.getElementById('filterInput').addEventListener('input', e=>{ state.filter=e.target.value; refreshPeople(); });
    document.getElementById('resetBtn').addEventListener('click', async ()=>{
      if(state.role!=='mmaster') return;
      const phrase='ì „ì²´ ì´ˆê¸°í™”';
      const input=prompt(`ì •ë§ ëª¨ë“  ê¸€ê³¼ ì°¸ê°€ì ëª©ë¡ì„ ì‚­ì œí• ê¹Œìš”?\në˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\ní™•ì¸ ë¬¸êµ¬: ${phrase}`);
      if(input!==phrase){ toast('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }
      try{ const {papers,participants}=await store.resetAll(); toast(`ì´ˆê¸°í™” ì™„ë£Œ: ê¸€ ${papers} Â· ì°¸ê°€ì ${participants}`); }
      catch(e){ toast('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: '+(e.message||e.code)); }
    });

    // ë’¤ë¡œê°€ê¸°
    document.getElementById('backFromMain').addEventListener('click', async ()=>{ try{ await store.signOut(); }catch{} goTo('loginView'); stack.length=0; });
    document.getElementById('backWrite').addEventListener('click', goBack);
    document.getElementById('cancelWrite').addEventListener('click', goBack);
    document.getElementById('backManage').addEventListener('click', goBack);
    document.getElementById('backAdminList').addEventListener('click', goBack);
    document.getElementById('backAdminRead').addEventListener('click', goBack);

    // ì €ì¥
    document.getElementById('savePaperBtn').addEventListener('click', async ()=>{
      const title=(document.getElementById('paperTitle').value||'').trim();
      const content=(document.getElementById('paperContent').value||'').trim();
      if(!currentTarget){ toast('ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      if(!title||!content){ toast('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
      try{
        if(editingPaperId){ await store.updatePaper(editingPaperId,{title,content}); toast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        else{ await store.createPaper({to:currentTarget, authorName: state.user.name, title, content}); toast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        goBack();
      }catch(e){ toast('ì €ì¥ ì¤‘ ì˜¤ë¥˜: '+(e.message||e.code)); }
    });
  }
  window.addEventListener('load', initApp);
  </script>
</body>
</html>
