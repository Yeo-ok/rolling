<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¡¤ë§í˜ì´í¼ - ì¹œêµ¬ìš© ì‹¤ì‹œê°„ (Firestore, ì¸ì¦ ì—†ìŒ)</title>
  <style>
    :root{
      --bg:#0f1226; --card:#171a35; --muted:#9aa3b2; --text:#e9ecf1;
      --accent:#5f7cff; --accent-2:#a8ff60; --danger:#ff5f7a; --warning:#ffc15f; --ok:#35d49a;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #1a1f45 0%, transparent 60%),
                  radial-gradient(800px 600px at 90% 10%, #1a2b45 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px;}
    .logo{display:flex; gap:10px; align-items:center}
    .logo i{width:36px; height:36px; background:linear-gradient(135deg,var(--accent),#9a7cff); border-radius:10px; box-shadow:var(--shadow)}
    .tag{padding:6px 10px; border:1px solid #2a2f56; border-radius:999px; color:var(--muted); font-size:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 60%), var(--card); border:1px solid #2a2f56; border-radius:var(--radius); box-shadow:var(--shadow);}
    .login{max-width:620px; margin:10vh auto 0; padding:24px;}
    .row{display:flex; gap:10px; align-items:center}
    input[type=text], textarea{width:100%; padding:12px 14px; border-radius:12px; border:1px solid #2a2f56; background:#0f1330; color:var(--text); outline:none}
    input[type=text]:focus, textarea:focus{border-color:var(--accent)}
    textarea{min-height:120px; resize:vertical}
    button{border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:700; background:var(--accent); color:white; box-shadow:var(--shadow)}
    button.outline{background:transparent; border:1px solid #334; color:var(--text)}
    button.ghost{background:transparent; color:var(--muted); box-shadow:none}
    button.danger{background:var(--danger)} button.ok{background:var(--ok); color:#072417}
    button:disabled{opacity:.5; cursor:not-allowed}
    .grid{display:grid; gap:14px; grid-template-columns: repeat( auto-fill, minmax(230px, 1fr) );}
    .person{padding:16px; display:flex; flex-direction:column; gap:10px; position:relative; overflow:hidden}
    .counts{display:flex; gap:10px; color:var(--muted); font-size:12px}
    .counts span{padding:4px 8px; border-radius:999px; background:#0f1330; border:1px solid #2a2f56}
    .pill{position:absolute; right:10px; top:10px; font-size:11px; color:#c5cbe3; padding:4px 8px; border-radius:999px; background:#0c0f24; border:1px solid #283056}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .hidden{display:none !important}
    .muted{color:var(--muted)}
    .center{display:flex; align-items:center; justify-content:center; text-align:center}
    .section{padding:16px}
    .h{font-size:18px; font-weight:800}
    .sub{font-size:12px; color:var(--muted)}
    .list{display:flex; flex-direction:column; gap:8px}
    .item{padding:12px; border:1px dashed #2a2f56; border-radius:12px; background:#0f1330}
    .item b{display:block; margin-bottom:6px}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 16px; border-bottom:1px solid #2a2f56}
    .content{padding:16px}
    .search{display:flex; gap:10px}
    .toast{position: fixed; left:50%; bottom: 22px; transform: translateX(-50%) translateY(20px); transition:.25s; opacity:0; background:#0c112a; color:var(--text); border:1px solid #283056; padding:10px 14px; border-radius:12px; box-shadow: var(--shadow); z-index:99;}
    .toast.show{opacity:1; transform: translateX(-50%) translateY(0)}
    .role-badge{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2a2f56; color:#cbd2ee}
    .online-dot{width:8px; height:8px; border-radius:50%; background:var(--ok); display:inline-block; margin-right:6px}
    .warn{color:var(--warning)} .hl{color:var(--accent-2); font-weight:800}
  </style>

  <!--
    ì¹œêµ¬ë“¤ë¼ë¦¬ ì“°ëŠ” ìš©ë„ì— ë§ì¶˜ "ë¬´ì¸ì¦(ë¡œê·¸ì¸ ì—†ì´) + ë°©ì½”ë“œ" ë²„ì „
    - Firebase Authenticationì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ â†’ Authorized domains ì¶”ê°€ ë¶ˆí•„ìš”
    - Firestore ê·œì¹™ì€ í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ì—´ì–´ ë‘ì…”ì•¼ í•©ë‹ˆë‹¤ (ìš´ì˜ê¶Œì¥X)
      rules_version = '2';
      service cloud.firestore {
        match /databases/{database}/documents {
          match /{document=**} {
            allow read, write: if true;
          }
        }
      }
    - ì•ˆì „ì„ ìœ„í•´ "ë°©ì½”ë“œ(ROOM) + ê´€ë¦¬ìPIN"ì„ íŒŒì¼ ìƒë‹¨ì—ì„œ ì§€ì •í•´ ë‘ì—ˆìŠµë‹ˆë‹¤.
      â†’ ê°™ì€ ë°©ì½”ë“œë¥¼ ì•„ëŠ” ì¹œêµ¬ë“¤ë¼ë¦¬ë§Œ ê°™ì€ ê³µê°„ì„ ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤.
  -->

  <!-- Firebase SDK (ì•± + Firestoreë§Œ) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <i></i>
        <div>
          <div><b>ë¡¤ë§í˜ì´í¼</b> <span class="tag">ì‹¤ì‹œê°„</span></div>
          <div class="sub">ì´ë¦„ìœ¼ë¡œ ì ‘ì† Â· ë°©ì½”ë“œë¡œ ëª¨ì´ê¸° Â· ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œë§Œ ì‘ì„± Â· ë‚´ ê¸€ë§Œ ì—´ëŒ/ìˆ˜ì •/ì‚­ì œ Â· ê´€ë¦¬ì ì—´ëŒ</div>
        </div>
      </div>
      <div id="statusArea" class="sub"></div>
    </header>

    <!-- ë¡œê·¸ì¸ -->
    <section id="login" class="card login">
      <div class="h">ì…ì¥í•˜ê¸°</div>
      <div class="section">
        <div class="row">
          <input id="roomInput" type="text" placeholder="ë°©ì½”ë“œ(ì˜ˆ: ABC123)" maxlength="24" />
          <input id="nameInput" type="text" placeholder="ì´ë¦„" maxlength="24" />
          <button id="enterBtn">ì…ì¥</button>
        </div>
        <div class="note" style="margin-top:12px">
          â€¢ ë°©ì½”ë“œëŠ” ì¹œêµ¬ë“¤ê³¼ ë¯¸ë¦¬ ê³µìœ í•œ ê°’ìœ¼ë¡œ ë§ì¶°ì£¼ì„¸ìš”. (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)<br/>
          â€¢ ê´€ë¦¬ì(ìˆ¨ê¹€ ì˜ˆì•½): <code>Master</code> / <code>mMaster</code> â†’ ê´€ë¦¬ì PIN í•„ìš”(ì•„ë˜ ì½”ë“œì—ì„œ ë³€ê²½ ê°€ëŠ¥)
        </div>
      </div>
    </section>

    <!-- ë©”ì¸ -->
    <section id="main" class="hidden">
      <div class="card section">
        <div class="topbar">
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
            <span id="hello"></span>
            <span id="roleBadge" class="role-badge"></span>
            <span id="roomBadge" class="role-badge"></span>
          </div>
          <div class="search">
            <input id="filterInput" type="text" placeholder="ì´ë¦„ ê²€ìƒ‰â€¦" />
            <button id="resetBtn" class="danger hidden">ì „ì²´ ì´ˆê¸°í™”(ê¸€)</button>
            <button id="logoutBtn" class="outline">ë‚˜ê°€ê¸°</button>
          </div>
        </div>
        <div class="content">
          <div id="peopleGrid" class="grid"></div>
        </div>
      </div>
    </section>

    <!-- ëª¨ë‹¬: ê¸€ì“°ê¸°/ìˆ˜ì • -->
    <dialog id="writeDialog">
      <div class="card modal">
        <div class="topbar">
          <div class="h"><span id="writeTitle">ë¡¤ë§í˜ì´í¼ ì‘ì„±</span></div>
          <button class="ghost" onclick="closeWrite()">ë‹«ê¸°</button>
        </div>
        <div class="content">
          <div class="sub muted" style="margin-bottom:8px"><span id="writeTargetLabel"></span></div>
          <input id="paperTitle" type="text" placeholder="ì œëª©" />
          <div style="height:10px"></div>
          <textarea id="paperContent" placeholder="ë‚´ìš©"></textarea>
          <div class="note" style="margin-top:10px">
            <b>ì•ˆë‚´</b> Â· ìƒëŒ€ë°©ì—ê²Œ ë‚¨ê¸°ëŠ” ë©”ì‹œì§€ì…ë‹ˆë‹¤. ì œëª©ê³¼ ë‚´ìš©ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
          </div>
        </div>
        <div class="footer">
          <button class="outline" onclick="closeWrite()">ì·¨ì†Œ</button>
          <button id="savePaperBtn">ì €ì¥</button>
        </div>
      </div>
    </dialog>

    <!-- ëª¨ë‹¬: ë‚´ ê¸€ ê´€ë¦¬ -->
    <dialog id="manageDialog">
      <div class="card modal">
        <div class="topbar">
          <div class="h">ë‚´ ê¸€ ê´€ë¦¬</div>
          <button class="ghost" onclick="closeManage()">ë‹«ê¸°</button>
        </div>
        <div class="content">
          <div class="sub muted" style="margin-bottom:10px"><span id="manageTargetLabel"></span>ì— ëŒ€í•´ ë‚´ê°€ ì“´ ê¸€ ëª©ë¡</div>
          <div id="myList" class="list"></div>
        </div>
      </div>
    </dialog>

    <!-- ëª¨ë‹¬: ê´€ë¦¬ì ì—´ëŒ -->
    <dialog id="adminDialog">
      <div class="card modal">
        <div class="topbar">
          <div class="h"><span id="adminTargetName"></span> ë‹˜ì—ê²Œ ì“°ì¸ ì „ì²´ ë¡¤ë§í˜ì´í¼</div>
          <button class="ghost" onclick="closeAdmin()">ë‹«ê¸°</button>
        </div>
        <div class="content">
          <div class="sub muted">ê´€ë¦¬ì ì—´ëŒ í™”ë©´ì…ë‹ˆë‹¤. <span id="adminAnonHint"></span></div>
          <div style="height:10px"></div>
          <div id="adminList" class="list"></div>
        </div>
      </div>
    </dialog>

    <div id="toast" class="toast"></div>
  </div>

  <!-- ğŸ”§ ì—¬ê¸°ë§Œ ë³¸ì¸ Firebase ì„¤ì •ìœ¼ë¡œ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤ -->
  <script>
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyA2sTHW22VtoAIXd2P8b9Nift0c-WPSLdM",
      authDomain: "rolling-7519c.firebaseapp.com",
      projectId: "rolling-7519c",
      storageBucket: "rolling-7519c.firebasestorage.app",
      messagingSenderId: "663780806800",
      appId: "1:663780806800:web:f6f6f850fd926eeb42c815"
    };

    // ì¹œêµ¬ ë°© ì „ìš© ì˜µì…˜ (ì›í•˜ëŠ” ê°’ìœ¼ë¡œ ë°”ê¿”ì„œ ê³µìœ í•˜ì„¸ìš”)
    window.FRIENDS_ONLY = {
      DEFAULT_ROOM_HINT: "ABC123",   // ë¡œê·¸ì¸ í™”ë©´ placeholder íŒíŠ¸
      REQUIRE_ROOM: true,            // ë°©ì½”ë“œ í•„ìˆ˜
      ADMIN_PIN: "4242"              // Master / mMaster ì‚¬ìš©í•  ë•Œ í•„ìš”í•œ PIN
    };
  </script>

  <script>
  // ========== ìœ í‹¸ ==========
  const $ = sel => document.querySelector(sel);
  const toast = (msg, ms=1800) => { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms); };
  const now = () => new Date();

  // ========== ìƒíƒœ ==========
  const state = { user: null, room: null, filter: '', role: 'user' };

  // ========== Firestore Store (ë¬´ì¸ì¦) ==========
  class FirestoreStore {
    constructor(config, room){
      this.app = firebase.initializeApp(config);
      this.db = firebase.firestore();
      this.room = room.toUpperCase();
      this.uid = localStorage.getItem('anonUid') || this._genId();
      localStorage.setItem('anonUid', this.uid);
      window.addEventListener('beforeunload', ()=>this._setPresence(false).catch(()=>{}));
    }
    _genId(){ if(window.crypto?.randomUUID) return crypto.randomUUID(); return Math.random().toString(36).slice(2)+Date.now().toString(36); }
    colParticipants(){ return this.db.collection('rooms').doc(this.room).collection('participants'); }
    colPapers(){ return this.db.collection('rooms').doc(this.room).collection('papers'); }

    async signIn(name){
      this.name = name;
      if(!['Master','mMaster'].includes(name)){
        await this.colParticipants().doc(name).set({
          name, uid: this.uid, online:true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastActive: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
      }
      return { uid: this.uid, name };
    }
    async _setPresence(online){
      if(!this.name || ['Master','mMaster'].includes(this.name)) return;
      await this.colParticipants().doc(this.name).set({
        online, lastActive: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    }
    async signOut(){ await this._setPresence(false); }

    onParticipantsChanged(cb){
      // participants + papers ë™ì‹œ ê°ì§€í•˜ì—¬ ì¹´ìš´íŠ¸ ê³„ì‚°
      const update = async () => {
        const [pSnap, papersSnap] = await Promise.all([
          this.colParticipants().get(),
          this.colPapers().get(),
        ]);
        const mine = this.name;
        const arr = pSnap.docs.map(d=>({name:d.id, ...(d.data()||{})}));
        for(const person of arr){
          const total = papersSnap.docs.filter(x=>x.data().to===person.name).length;
          const own = papersSnap.docs.filter(x=>x.data().to===person.name && x.data().authorName===mine).length;
          person.countTotal = total; person.countMine = own;
        }
        arr.sort((a,b)=> a.name.localeCompare(b.name,'ko'));
        cb(arr);
      };
      this.colParticipants().onSnapshot(update);
      this.colPapers().onSnapshot(update);
    }

    async ensurePerson(name){
      const doc = await this.colParticipants().doc(name).get();
      if(!doc.exists && !['Master','mMaster'].includes(name)){
        await this.colParticipants().doc(name).set({name, online:false, createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      }
    }
    async createPaper({to, authorName, title, content}){
      const doc = await this.colPapers().add({
        to, authorName, authorUid: this.uid, title, content,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      return {id: doc.id, to, authorName, title, content};
    }
    async listMyPapersTo(to, authorName){
      const snap = await this.colPapers()
        .where('to','==',to).where('authorName','==',authorName).orderBy('updatedAt','desc').get();
      return snap.docs.map(d=>({id:d.id, ...d.data()}));
    }
    async listAllTo(to){
      const snap = await this.colPapers()
        .where('to','==',to).orderBy('updatedAt','desc').get();
      return snap.docs.map(d=>({id:d.id, ...d.data()}));
    }
    async updatePaper(id, {title, content}){
      await this.colPapers().doc(id).update({
        title, content, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      const d = await this.colPapers().doc(id).get();
      return {id, ...d.data()};
    }
    async deletePaper(id){
      await this.colPapers().doc(id).delete();
    }
    async resetAllPapers(){
      // í˜„ì¬ ë°©ì˜ papersë§Œ ì „ì²´ ì‚­ì œ
      let total = 0;
      while(true){
        const snap = await this.colPapers().limit(450).get();
        if(snap.empty) break;
        const batch = this.db.batch();
        snap.docs.forEach(doc=> batch.delete(doc.ref));
        await batch.commit();
        total += snap.docs.length;
      }
      return total;
    }
  }

  // ========== ì´ˆê¸°í™” ==========
  let store = null;
  const statusArea = document.getElementById('statusArea');

  // ========== UI ë°”ì¸ë”© ==========
  const loginEl = document.getElementById('login');
  const mainEl = document.getElementById('main');
  const helloEl = document.getElementById('hello');
  const roleBadge = document.getElementById('roleBadge');
  const roomBadge = document.getElementById('roomBadge');
  const peopleGrid = document.getElementById('peopleGrid');
  const filterInput = document.getElementById('filterInput');
  const resetBtn = document.getElementById('resetBtn');

  const writeDialog = document.getElementById('writeDialog');
  const paperTitle = document.getElementById('paperTitle');
  const paperContent = document.getElementById('paperContent');
  const writeTargetLabel = document.getElementById('writeTargetLabel');

  const manageDialog = document.getElementById('manageDialog');
  const manageTargetLabel = document.getElementById('manageTargetLabel');
  const myList = document.getElementById('myList');

  const adminDialog = document.getElementById('adminDialog');
  const adminTargetName = document.getElementById('adminTargetName');
  const adminAnonHint = document.getElementById('adminAnonHint');
  const adminList = document.getElementById('adminList');

  let editingPaperId = null;
  let currentTarget = null;
  let participantsCache = [];

  function roleOf(name){ if(name==='Master') return 'master'; if(name==='mMaster') return 'mmaster'; return 'user'; }
  function isAdmin(){ return state.role==='master' || state.role==='mmaster'; }

  function applyRoleUI(){
    helloEl.innerHTML = `<span class="online-dot"></span><b>${state.user?.name}</b> ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
    roleBadge.textContent = state.role==='master' ? 'ê´€ë¦¬ì' : state.role==='mmaster' ? 'ìµœëŒ€ ê´€ë¦¬ì' : 'ì¼ë°˜ ì‚¬ìš©ì';
    roomBadge.textContent = `ë°©: ${state.room}`;
    if(state.role==='mmaster') resetBtn.classList.remove('hidden'); else resetBtn.classList.add('hidden');
  }

  async function refreshPeople(){
    const f = (state.filter||'').trim().toLowerCase();
    const list = participantsCache.filter(p => !f || p.name.toLowerCase().includes(f));
    peopleGrid.innerHTML = '';
    if(list.length===0){
      peopleGrid.innerHTML = '<div class="center muted" style="padding:40px">ì•„ì§ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return;
    }
    const me = state.user?.name;
    for(const person of list){
      const el = document.createElement('div');
      el.className = 'person card';
      el.innerHTML = `
        <span class="pill">${person.online? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸'}</span>
        <div class="h">${person.name}</div>
        <div class="counts">
          <span title="ì „ì²´">${person.countTotal ?? 0} ê°œ</span>
          <span title="ë‚´ê°€ ì‘ì„±">${person.countMine ?? 0} ê°œ (ë‚´ ê¸€)</span>
        </div>
        <div class="toolbar">
          <button ${person.name===me?'disabled':''} data-act="write">ì“°ê¸°</button>
          <button class="outline" ${person.name===me?'disabled':''} data-act="manage">ìˆ˜ì •Â·ì‚­ì œ</button>
          ${isAdmin()? `<button class="ok" data-act="admin">ê´€ë¦¬ì ì—´ëŒ</button>` : ''}
        </div>
      `;
      el.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', async () => {
          const act = btn.dataset.act;
          if(person.name===me && (act==='write'||act==='manage')){ toast('ìê¸° ìì‹ ì˜ í˜ì´ì§€ì—ëŠ” ë“¤ì–´ê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
          if(act==='write'){ currentTarget = person.name; openWrite({mode:'create'}); }
          else if(act==='manage'){ currentTarget = person.name; openManage(person.name); }
          else if(act==='admin'){ openAdmin(person.name); }
        });
      });
      peopleGrid.appendChild(el);
    }
  }

  function openWrite({mode, paper}){
    document.getElementById('writeTitle').textContent = mode==='edit' ? 'ë¡¤ë§í˜ì´í¼ ìˆ˜ì •' : 'ë¡¤ë§í˜ì´í¼ ì‘ì„±';
    writeTargetLabel.textContent = `ëŒ€ìƒ: ${currentTarget}`;
    editingPaperId = (mode==='edit' && paper) ? paper.id : null;
    paperTitle.value = paper?.title || '';
    paperContent.value = paper?.content || '';
    writeDialog.showModal();
  }
  function closeWrite(){ writeDialog.close(); editingPaperId = null; currentTarget = null; paperTitle.value=''; paperContent.value=''; }

  async function openManage(target){
    manageTargetLabel.textContent = `ëŒ€ìƒ ${target}`;
    const mine = await store.listMyPapersTo(target, state.user.name);
    myList.innerHTML = '';
    if(mine.length===0){
      myList.innerHTML = '<div class="center muted item">ì•„ì§ ì‘ì„±í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }else{
      for(const p of mine){
        const date = new Date(p.updatedAt?.toDate?.() || p.updatedAt || p.createdAt?.toDate?.() || p.createdAt || Date.now());
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
          <b>${p.title || '(ì œëª© ì—†ìŒ)'}</b>
          <div class="muted" style="font-size:12px; margin-bottom:8px">${new Date(date).toLocaleString()}</div>
          <div style="white-space:pre-wrap">${p.content || ''}</div>
          <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end">
            <button class="outline" data-act="edit">ìˆ˜ì •</button>
            <button class="danger" data-act="del">ì‚­ì œ</button>
          </div>
        `;
        item.querySelector('[data-act="edit"]').onclick = ()=>{ currentTarget = target; openWrite({mode:'edit', paper:p}); };
        item.querySelector('[data-act="del"]').onclick = async ()=>{
          if(confirm('ì´ ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')){ await store.deletePaper(p.id); toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); openManage(target); }
        };
        myList.appendChild(item);
      }
    }
    manageDialog.showModal();
  }
  function closeManage(){ manageDialog.close(); myList.innerHTML=''; }

  async function openAdmin(target){
    adminTargetName.textContent = target;
    const isSuper = state.role==='mmaster';
    adminAnonHint.innerHTML = isSuper ? 'ì‘ì„±ì í‘œì‹œ <span class="hl">(mMaster)</span>' : 'ì‘ì„±ì ìˆ¨ê¹€ <span class="hl">(Master)</span>';
    const all = await store.listAllTo(target);
    adminList.innerHTML='';
    if(all.length===0){
      adminList.innerHTML = '<div class="center muted item">ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }else{
      for(const p of all){
        const date = new Date(p.updatedAt?.toDate?.() || p.updatedAt || p.createdAt?.toDate?.() || p.createdAt || Date.now());
        const authorLabel = isSuper ? `<span class="warn">ì‘ì„±ì: ${p.authorName || 'ì•Œìˆ˜ì—†ìŒ'}</span>` : `<span class="muted">ì‘ì„±ì: ìµëª…</span>`;
        const item = document.createElement('div');
        item.className='item';
        item.innerHTML = `
          <b>${p.title || '(ì œëª© ì—†ìŒ)'}</b>
          <div class="muted" style="font-size:12px; margin-bottom:8px">${authorLabel} Â· ${new Date(date).toLocaleString()}</div>
          <div style="white-space:pre-wrap">${p.content || ''}</div>
        `;
        adminList.appendChild(item);
      }
    }
    adminDialog.showModal();
  }
  function closeAdmin(){ adminDialog.close(); adminList.innerHTML=''; }

  // ========== ì´ë²¤íŠ¸ ==========
  document.getElementById('enterBtn').addEventListener('click', async ()=>{
    const roomRaw = (document.getElementById('roomInput').value || window.FRIENDS_ONLY?.DEFAULT_ROOM_HINT || '').trim();
    const nameRaw = (document.getElementById('nameInput').value || '').trim();
    if(window.FRIENDS_ONLY?.REQUIRE_ROOM && !roomRaw){ toast('ë°©ì½”ë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
    if(!nameRaw){ toast('ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }

    // ê´€ë¦¬ì ì´ë¦„ ë³´í˜¸ (PIN í•„ìš”)
    let role = roleOf(nameRaw);
    if(role==='master' || role==='mmaster'){
      const pin = prompt('ê´€ë¦¬ì PINì„ ì…ë ¥í•˜ì„¸ìš”');
      if(pin !== (window.FRIENDS_ONLY?.ADMIN_PIN || '4242')){
        alert('PINì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
    }

    // ì´ˆê¸°í™”
    state.room = (roomRaw || 'DEFAULT').toUpperCase();
    store = new FirestoreStore(window.FIREBASE_CONFIG, state.room);

    try{
      await store.signIn(nameRaw);
      await store.ensurePerson(nameRaw);
      state.user = { name: nameRaw };
      state.role = role;

      // UI ì „í™˜
      loginEl.classList.add('hidden');
      mainEl.classList.remove('hidden');
      applyRoleUI();
      statusArea.innerHTML = `ë°±ì—”ë“œ: <b>Firestore</b> ì—°ê²°ë¨ Â· <span class="muted">ì¸ì¦ ì—†ìŒ(ì¹œêµ¬ìš©)</span>`;

      // ì‹¤ì‹œê°„ ëª©ë¡
      store.onParticipantsChanged((list)=>{
        participantsCache = list;
        refreshPeople();
      });

      toast('ì…ì¥í–ˆìŠµë‹ˆë‹¤.');
    }catch(e){
      console.error(e);
      toast('ì…ì¥ ì‹¤íŒ¨');
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', async ()=>{
    if(store){ await store.signOut().catch(()=>{}); }
    location.reload();
  });

  filterInput.addEventListener('input', ()=>{ state.filter = filterInput.value; refreshPeople(); });

  // mMaster ì „ìš©: í˜„ì¬ ë°©ì˜ ê¸€ ì „ì²´ ì´ˆê¸°í™”
  resetBtn.addEventListener('click', async ()=>{
    if(state.role!=='mmaster') return;
    const phrase = `${state.room} ë°© ì „ì²´ ì´ˆê¸°í™”`;
    const input = prompt(`ì •ë§ ì´ ë°©(${state.room})ì˜ ëª¨ë“  ê¸€ì„ ì‚­ì œí• ê¹Œìš”?\në˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\ní™•ì¸ ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n${phrase}`);
    if(input!==phrase){ toast('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }
    try{
      const deleted = await store.resetAllPapers();
      toast(`ì´ˆê¸°í™” ì™„ë£Œ: ${deleted}ê±´ ì‚­ì œë¨`);
    }catch(e){
      console.error(e);
      toast('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜');
    }
  });

  // ì €ì¥
  document.getElementById('savePaperBtn').addEventListener('click', async ()=>{
    const title = (paperTitle.value||'').trim();
    const content = (paperContent.value||'').trim();
    if(!currentTarget){ toast('ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
    if(!title || !content){ toast('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
    try{
      if(editingPaperId){
        await store.updatePaper(editingPaperId, {title, content});
        toast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }else{
        await store.createPaper({to: currentTarget, authorName: state.user.name, title, content});
        toast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
      closeWrite();
    }catch(e){
      console.error(e);
      toast('ì €ì¥ ì¤‘ ì˜¤ë¥˜');
    }
  });
  </script>
</body>
</html>
